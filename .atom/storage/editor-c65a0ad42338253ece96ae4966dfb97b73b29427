{"mode":"editor","version":1,"windowDimensions":{"x":0,"y":23,"width":1440,"height":803,"maximized":true},"grammars":{"deserializer":"GrammarRegistry","grammarOverridesByPath":{}},"project":{"paths":["/Users/sanoy/code/fatalshootings"],"buffers":[{"text":"web: node explore/bin/www","markerStore":{"nextMarkerId":34,"markersById":{"0":{"range":{"start":{"row":0,"column":25},"end":{"row":0,"column":25}},"properties":{"type":"selection","editorId":122,"goalScreenRange":null,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true}},"version":2},"history":{"version":2,"nextCheckpointId":1,"undoStack":[],"redoStack":[]},"encoding":"utf8","filePath":"/Users/sanoy/code/fatalshootings/fatalshootings/Procfile","modifiedWhenLastPersisted":false,"digestWhenLastPersisted":"54db5a2d66bbb8b987996a54d2bff67292abeee3","preferredLineEnding":"\n","deserializer":"TextBuffer","version":2},{"text":"var __base = __base || '../',\r\n    c = require(__base + 'shared-config/constants'),\r\n    log = c.getLog('shared-views/fatality-list'),\r\n    httpGet = require(__base + 'shared-utils/http-get'),\r\n\r\n    //node require\r\n    q = require('q'),\r\n\r\n    //app require\r\n    getView = require(__base + 'shared-utils/get-view'),\r\n    filterUtils = require(__base + 'shared-utils/query-filters');\r\n\r\nmodule.exports = function(d, cb) {\r\n\r\n    var collection = d._db.fatalities,\r\n        filter = filterUtils.validateFilters(d.filters);\r\n\r\n    filter.pending = d.pending ? true : false;\r\n\r\n    function getQueryFilterOptions() {\r\n\r\n        log('trace', 'attempt to get query filter options');\r\n\r\n        var deferred = q.defer();\r\n\r\n        getView(d._str._lang, 'fatality-list-filter', {\r\n\r\n            url_current: d.locals.url_current,\r\n            url_distinct: d.locals.url_distinct,\r\n            collection: collection,\r\n            filters: filter\r\n        \r\n        }, function(err, data) {\r\n\r\n            if(err){\r\n\r\n                log('error', 'could not get query filter options', err);\r\n                deferred.reject(err);\r\n            }\r\n\r\n            log('trace', 'got query filter options');\r\n\r\n            deferred.resolve({\r\n                filterView: data\r\n            });\r\n        });\r\n\r\n        return deferred.promise;\r\n    }\r\n\r\n    //get result entries for current page\r\n    function getResults(data) {\r\n\r\n        log('trace', 'attempt to get results');\r\n\r\n        var deferred = q.defer();\r\n\r\n        httpGet(filterUtils.buildFilterURL(d.locals.url_data, filter), function(err, body){\r\n\r\n            if(err){\r\n\r\n                log('error', 'get results', err);\r\n                return;\r\n            }\r\n\r\n            log('trace', 'got results');\r\n\r\n            deferred.resolve({\r\n\r\n                body: body.body,\r\n                count: body.count,\r\n                filterView: data.filterView\r\n            });\r\n        })\r\n\r\n        return deferred.promise;\r\n    }\r\n\r\n    function returnData(data) {\r\n\r\n        log('trace', 'return results');\r\n\r\n        cb(null, {\r\n\r\n            results: data.body,\r\n            count: data.count,\r\n            admin: d.admin,\r\n            pending: d.pending,\r\n            filters: data.filterView.html,\r\n\r\n            pagination: getView(d._str._lang, 'components/pagination', {\r\n\r\n                count: data.count,\r\n                current: filter.page,\r\n                limit: filter.limit,\r\n                url: filterUtils.buildFilterURL('/list', filter, { page: false })\r\n            \r\n            }).html\r\n        });\r\n    }\r\n\r\n    //first two calls can happen at the same time\r\n    getQueryFilterOptions()\r\n    .then(getResults)\r\n    .then(returnData)\r\n    .fail(function(err) {\r\n\r\n        log('error', 'could not get fatality list view', err);\r\n        cb(err);\r\n\r\n    });\r\n\r\n}","markerStore":{"nextMarkerId":3,"markersById":{"0":{"range":{"start":{"row":25,"column":15},"end":{"row":25,"column":15}},"properties":{"type":"selection","editorId":202,"goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"1":{"range":{"start":{"row":25,"column":15},"end":{"row":25,"column":16}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap","maintainHistory":false},"2":{"range":{"start":{"row":45,"column":9},"end":{"row":45,"column":10}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap","maintainHistory":false}},"version":2},"history":{"version":2,"nextCheckpointId":1,"undoStack":[],"redoStack":[]},"encoding":"utf8","filePath":"/Users/sanoy/code/fatalshootings/fatalshootings/shared-views/fatality-list.js","modifiedWhenLastPersisted":false,"digestWhenLastPersisted":"c06b7f26d0c89a154d395aedb75bcd318091418c","preferredLineEnding":null,"deserializer":"TextBuffer","version":2},{"text":"var __base = __base || '../',\n    c = require(__base + 'shared-config/constants'),\n    log = c.getLog('shared-views/contact');\n\nmodule.exports = function(d, cb) {\n\n    cb(null, d);\n}","markerStore":{"nextMarkerId":1,"markersById":{"0":{"range":{"start":{"row":0,"column":0},"end":{"row":0,"column":0}},"properties":{"type":"selection","editorId":210},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true}},"version":2},"history":{"version":2,"nextCheckpointId":1,"undoStack":[],"redoStack":[]},"encoding":"utf8","filePath":"/Users/sanoy/code/fatalshootings/fatalshootings/shared-views/admin-home.js","modifiedWhenLastPersisted":false,"digestWhenLastPersisted":"2652345a4cff1604d7ce485ed441a6372e7c277f","preferredLineEnding":null,"deserializer":"TextBuffer","version":2},{"text":"db['test-fatalities'].group( {\n    $keyf: function(doc) {\n        return { 'value.subject.race' : doc.value.subject.race };\n    },\n    reduce: function(cur, result) { 0\n        result.count++ \n    },\n    initial: { count: 0 }\n});\n\ndb['test-fatalities'].group( {\n    $keyf: function(doc) {\n        return { 'value.subject.age' : doc.value.subject.age };\n    },\n    reduce: function(cur, result) { \n        result.count++;\n    },\n    initial: { count: 0 }\n});\n\ndb['test-fatalities'].group( {\n    $keyf: function(doc) {\n        return { 'value.death.cause' : doc.value.death.cause };\n    },\n    reduce: function(cur, result) { \n        result.count++ \n    },\n    initial: { count: 0 }\n});\n\ndb['test-fatalities'].group( {\n    $keyf: function(doc) {\n        return { 'value.location.state' : doc.value.location.state };\n    },\n    reduce: function(cur, result) {\n        result.count++;\n        result.name = cur.value.subject.name;\n    },\n    initial: { count: 0 }\n});","markerStore":{"nextMarkerId":1,"markersById":{"0":{"range":{"start":{"row":0,"column":0},"end":{"row":0,"column":0}},"properties":{"type":"selection","editorId":214},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true}},"version":2},"history":{"version":2,"nextCheckpointId":1,"undoStack":[],"redoStack":[]},"encoding":"utf8","filePath":"/Users/sanoy/code/fatalshootings/fatalshootings/shared-utils/db-queries/aggregate-count-queries.js","modifiedWhenLastPersisted":false,"digestWhenLastPersisted":"b6a5f18bd8a76caad669cd1956e30227fa8b2001","preferredLineEnding":null,"deserializer":"TextBuffer","version":2}],"deserializer":"Project"},"workspace":{"paneContainer":{"root":{"id":3,"items":[{"id":122,"softTabs":true,"displayBuffer":{"id":123,"softWrapped":false,"scrollTop":0,"scrollLeft":0,"tokenizedBuffer":{"bufferPath":"/Users/sanoy/code/fatalshootings/fatalshootings/Procfile","largeFileMode":false,"deserializer":"TokenizedBuffer"},"largeFileMode":false,"deserializer":"DisplayBuffer"},"deserializer":"TextEditor"},{"id":202,"softTabs":true,"displayBuffer":{"id":203,"softWrapped":false,"scrollTop":0,"scrollLeft":0,"tokenizedBuffer":{"bufferPath":"/Users/sanoy/code/fatalshootings/fatalshootings/shared-views/fatality-list.js","largeFileMode":false,"deserializer":"TokenizedBuffer"},"largeFileMode":false,"deserializer":"DisplayBuffer"},"deserializer":"TextEditor"},{"id":210,"softTabs":true,"displayBuffer":{"id":211,"softWrapped":false,"scrollTop":0,"scrollLeft":0,"tokenizedBuffer":{"bufferPath":"/Users/sanoy/code/fatalshootings/fatalshootings/shared-views/admin-home.js","largeFileMode":false,"deserializer":"TokenizedBuffer"},"largeFileMode":false,"deserializer":"DisplayBuffer"},"deserializer":"TextEditor"},{"id":214,"softTabs":true,"displayBuffer":{"id":215,"softWrapped":false,"scrollTop":0,"scrollLeft":0,"tokenizedBuffer":{"bufferPath":"/Users/sanoy/code/fatalshootings/fatalshootings/shared-utils/db-queries/aggregate-count-queries.js","largeFileMode":false,"deserializer":"TokenizedBuffer"},"largeFileMode":false,"deserializer":"DisplayBuffer"},"deserializer":"TextEditor"}],"activeItemURI":"/Users/sanoy/code/fatalshootings/fatalshootings/shared-utils/db-queries/aggregate-count-queries.js","focused":false,"flexScale":1,"deserializer":"Pane"},"activePaneId":3,"deserializer":"PaneContainer","version":1},"fullScreen":false,"packagesWithActiveGrammars":["language-javascript","language-hyperlink","language-todo"],"deserializer":"Workspace"},"packageStates":{"find-and-replace":{"findOptions":{"findPattern":"procfile","replacePattern":"","pathsPattern":"","useRegex":false,"wholeWord":false,"caseSensitive":false,"inCurrentSelection":false},"findHistory":["contact form","msg","contact for","contact","procfile"],"replaceHistory":[],"pathsHistory":[]},"fuzzy-finder":{"/Users/sanoy/code/fatalshootings/fatalshootings/Procfile":1441308714147,"/Users/sanoy/code/fatalshootings/fatalshootings/shared-views/fatality-list.js":1441308719018,"/Users/sanoy/code/fatalshootings/fatalshootings/shared-views/admin-home.js":1441308972251,"/Users/sanoy/code/fatalshootings/fatalshootings/shared-utils/db-queries/aggregate-count-queries.js":1441308981468},"metrics":{"sessionLength":2302366},"tabs":[{}],"tree-view":{"directoryExpansionStates":{"/Users/sanoy/code/fatalshootings":{"isExpanded":true,"entries":{".git":{"isExpanded":false,"entries":{}},"fatalshootings":{"isExpanded":true,"entries":{".git":{"isExpanded":false,"entries":{}},"_admin":{"isExpanded":false,"entries":{}},"_sys-admin":{"isExpanded":false,"entries":{}},"admin":{"isExpanded":true,"entries":{"bin":{"isExpanded":false,"entries":{}},"public":{"isExpanded":false,"entries":{}},"routes":{"isExpanded":true,"entries":{}}}},"explore":{"isExpanded":true,"entries":{"bin":{"isExpanded":false,"entries":{}},"public":{"isExpanded":false,"entries":{}},"routes":{"isExpanded":false,"entries":{}}}},"lang":{"isExpanded":false,"entries":{}},"log":{"isExpanded":false,"entries":{}},"node_modules":{"isExpanded":false,"entries":{}},"shared-config":{"isExpanded":true,"entries":{}},"shared-utils":{"isExpanded":true,"entries":{"db-queries":{"isExpanded":true,"entries":{}},"schemas":{"isExpanded":true,"entries":{}},"schemas-cache":{"isExpanded":true,"entries":{}}}},"shared-views":{"isExpanded":true,"entries":{"components":{"isExpanded":false,"entries":{}},"fatality-record-partials":{"isExpanded":false,"entries":{}}}},"sys-admin":{"isExpanded":true,"entries":{"sample-data":{"isExpanded":false,"entries":{}}}}}}}}},"selectedPath":"/Users/sanoy/code/fatalshootings/fatalshootings/shared-utils/db-queries/aggregate-count-queries.js","hasFocus":true,"attached":true,"scrollLeft":0,"scrollTop":487,"width":307},"keybinding-resolver":{}}}